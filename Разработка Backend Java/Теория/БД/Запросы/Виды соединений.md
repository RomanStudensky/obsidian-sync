
## B. Физические подключения к PostgreSQL (каналы, способы аутентификации, pooling)

### 1. Транспортные каналы

|Канал|Где применяется|Как задать|
|---|---|---|
|**UNIX‑сокет** (файл `/.s.PGSQL.5432`)|Локально на том же сервере; самый быстрый|`psql -h /var/run/postgresql db`|
|**TCP/IP** (IPv4 / IPv6)|Подключение с‑клиентских машин|`psql -h 192.0.2.15 -p 5432 db`|
|**TCP + SSL/TLS**|Шифрование «на лету» (Internet, облака)|`sslmode=require` / `verify-full`|
|**SSH‑туннель / VPN**|Когда нельзя (или не хотим) открывать порт 5432 наружу|`ssh -L 55432:localhost:5432 user@host`|

> _Совет:_ для production оставьте открыт только 5432/tcp, запретив внешние UNIX‑сокеты через `unix_socket_directories`.

---

### 2. Методы аутентификации (`pg_hba.conf`)

|Метод|Где уместен|Пример строки|
|---|---|---|
|`trust`|Только лабораторные стенды|`local all all trust`|
|`peer`|Локальные UNIX‑сокеты под тем же системным юзером|`local all all peer`|
|`password` (`md5`)|Устаревает (заменяйте на SCRAM)|`host all all 0.0.0.0/0 md5`|
|`scram-sha-256`|Современный безопасный парольный вход|`host all all 0.0.0.0/0 scram-sha-256`|
|`cert`|X.509‑сертификаты (mTLS)|`hostssl all all 0.0.0.0/0 cert`|
|`gss`, `sspi`|Kerberos/AD (SAML/Fed‑SSO)|`host all all .example.com gss`|
|`ldap`, `radius`, `pam`|Делегирование на внешние службы|`host all all 0.0.0.0/0 ldap ldapserver= …`|
|`ident`|Старый вариант peer по TCP|редко используется|

---

### 3. Типы «особых» подключений

| Тип                                       | Что делает                            | Как подключиться                                  |
| ----------------------------------------- | ------------------------------------- | ------------------------------------------------- |
| **Стандартная сессия**                    | Любое клиентское приложение           | DSN/URL, psql, JDBC, psycopg                      |
| **Репликационное**                        | Streaming replication (WAL‑sender)    | `psql "replication=database"`                     |
| **Логическая репликация**                 | `pgoutput`/`test_decoding`/`wal2json` | `CREATE PUBLICATION …` + `pg_recvlogical …`       |
| **Пуллинг** (PgBouncer)                   | Мультиплексирование сокетов           | клиент → PgBouncer:6432 → Postgres                |
| **Фоновый воркер / расширение**           | Внутренний бекэнд (C‑API)             | `shared_preload_libraries = 'pg_stat_statements'` |
| **Автоматическое подключение к монитору** | Checkpointer, autovacuum, walwriter   | создаются самим PostgreSQL                        |

Чтобы посмотреть активные сессии:

```sql
SELECT pid, usename, application_name, state, backend_type, client_addr FROM   pg_stat_activity;
```
---

### 4. Жизненный цикл соединений

|Событие|Настройка / параметр|
|---|---|
|Idle‑timeout|`tcp_keepalives_idle`, `tcp_keepalives_interval`|
|Лимит простоя в транзакции|`idle_in_transaction_session_timeout`|
|Ограничение времени запроса|`statement_timeout`|
|Максимум одновременных коннектов|`max_connections` (Postgres) + `pool_size` (PgBouncer)|

---

### 5. Connection Pooling — когда и зачем

|Модель|Как работает|Плюсы|Минусы|
|---|---|---|---|
|**Без пула**|Клиент ↔ Postgres (1 = 1)|Простой конфиг|Много RAM/CPU на бекэнды|
|**PgBouncer — session mode**|Коннект «прирезается» на всё время сессии|Совместимо с любыми фичами|Экономия умеренная|
|**PgBouncer — transaction mode**|Бэкенд выдаётся на время транзакции|Высокая экономия, >10 000 соединений|Нельзя юзать `LISTEN/NOTIFY`, temp tables|
|**PgBouncer — statement mode**|Бэкенд на _один_ запрос|Максимальная плотность|Очень много ограничений, редко нужен|

---

### 6. Полезные libpq‑параметры

|Параметр|Пример значения|Зачем|
|---|---|---|
|`application_name`|`myapp‑api‑pod‑17`|Легче читать `pg_stat_activity`|
|`target_session_attrs`|`read‑write`|Клиент автоматически отбирает master|
|`options`|`-c search_path=public,ext`|Установка GUC при подключении|

---

### Как это выглядит на практике
```bash
# Локально через UNIX‑сокет с peer‑аутентификацией 
psql -d mydb -U appuser -h /run/postgresql  
# Удалённо через TCP + TLS, пароль SCRAM 
psql "postgresql://appuser@db.example.com:5432/mydb?sslmode=require"  
# Подключение реплики для бэкапов 
pg_basebackup -h replica.local -D /backup --username=backup --wal-method=stream
```

---
  
### Вывод

- **Клиентские соединения** делятся по транспортному каналу (UNIX vs TCP vs SSL), способу аутентификации, назначению (обычные, репликация, воркеры) и по моделям пула.

- Характеристики подключения настраиваются одновременно в **`postgresql.conf` / `pg_hba.conf`** (сервер) и в **DSN‑строке** (клиент).

