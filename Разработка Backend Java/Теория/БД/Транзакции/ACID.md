Свойства транзакций ACID

Атомарность, Согласованность, Изолированность, Долговечность

1. **Атомарность**. Либо будут зафиксированы все операции, либо никакие. 
В _PostgreSQL_ обеспечивается механизмом журналирования _WAL_ (_Write-Ahead Logging_). Когда транзакция начинается, все изменения записываются сначала в журнал _WAL_, который хранится на диске. После завершения всех операций транзакции данные записываются в основную базу.

2. **Согласованность**. При успешном выполнении транзакции БД была переведена из одного согласованного состояния в другое.
В _PostgreSQL_ обеспечивается первичными и внешними ключами, уникальными индексами и проверками (_CHECK_), которые помогают поддерживать согласованность данных. Триггеры позволяют выполнять дополнительные проверки и модификации данных перед или после изменений, обеспечивая соблюдение бизнес-правил.

3. **Изолированность**. Во время выполнения транзакции другие транзакции должны оказывать по возможности минимальное влияние на неё. 

В _PostgreSQL_ поддерживается несколько *уровней изоляции транзакций*, что позволяет контролировать степень видимости изменений:
- _Read Uncommitted_ – не поддерживается.
- _Read Committed_ – по умолчанию. Видит зафиксированные изменения, сделанные до начала текущей команды.
- _Repeatable Read_ – видит только зафиксированные изменения, сделанные до её начала, и сохраняет этот снимок на всё время выполнения.
- _Serializable_ – транзакции выполняются так, как если бы они были последовательными, избегая межтранзакционных аномалий.
Уровни видимости описаны вкратце, смотреть главу Изоляция транзакций.

4. **Долговечность**. После успешной фиксации транзакции пользователь должен быть уверен, что данные надежно сохранены. Подробнее ниже

Перед фиксацией изменений в БД они записываются в _WAL_ журнал, который хранится на диске. 

Запись синхронизируется на диск перед фиксацией транзакции. В случае сбоя изменения можно восстановить из журнала.

Периодически _PostgreSQL_ создает контрольные точки, записывая текущее состояние базы данных на диск. Это уменьшает время восстановления после сбоев.


**Аномалии при параллельном выполнении транзакций**

**Потерянное обновление (lost update)**. При обновлении данных в разных транзакциях после фиксации данных может оказаться так, что одна транзакция перезаписала данные, обновленные и зафиксированные другой транзакцией.

**«Грязное» чтение**. Транзакция читает данные, измененные параллельной транзакцией, которая еще не завершилась. Если параллельная транзакция будет отменена, то первая транзакция прочитала данные, которых нет в системе.

**Неповторяющееся чтение**. При повторном чтении тех же самых данных _в рамках одной транзакции_ можно получить строки с иными значениями. (может быть полезно – проверка исходных данных расчета перед фиксацией транзакции и пересчет в ином случае).

**Фантомное чтение**. При повторном чтении данных по одним и тем же критериям _в рамках одной транзакции_ можно получить большее кол-во строк. Это происходит по причине записи новых строк другой транзакцией в базу в промежутке между выборками.

**Аномалия сериализации**. При фиксации нескольких транзакций, выполняющихся параллельно, получаем результат, не совпадающий с результатом их последовательного выполнения.