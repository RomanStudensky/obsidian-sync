В _PostgreSQL_ транзакции основаны на многоверсионной модели (_Multiversion_ _Concurrency_ _Control_, _MVCC_).

Модель предполагает, что каждый SQL-оператор видит так называемый снимок данных (snapshot), т.е. то согласованное состояние БД, которое она имела на определенный момент времени. Т.е. версию строки на момент ее последнего изменения/удаления (максимальное значение _xmax_).

Основные концепции

- Версии строк: Каждая строка в таблице имеет два скрытых поля:

_xmin_: идентификатор транзакции, которая создала или обновила строку.

_xmax_: идентификатор транзакции, которая удалила или обновила строку.

- Снапшот (_Snapshot_): Каждая транзакция при запуске берет снимок базы данных, который включает все изменения, зафиксированные до её начала.

- Сборка мусора (_Vacuum_): для удаления старых версий строк используется команда _VACUUM_, которая освобождает место в таблицах.

Пример работы _MVCC_ на следующей странице

Пример работы _MVCC_

  

Инициализация: Таблица с одной строкой.

| id  | data | xmin | xmax |
| --- | ---- | ---- | ---- |
| 1   | 100  | T1   | -    |

  
Начало транзакции T2: Транзакция T2 начинает чтение таблицы.

| id  | data | xmin | xmax |
| --- | ---- | ---- | ---- |
| 1   | 100  | T1   | -    |


Обновление строки в транзакции T3: Транзакция T3 обновляет строку.

| id  | data | xmin | xmax |
| --- | ---- | ---- | ---- |
| 1   | 100  | T1   | T3   |
| 1   | 200  | T3   | -    |

Чтение данных транзакцией T2: Транзакция T2 видит старую версию строки, так как новая версия была создана после её начала.

| id  | data | xmin | xmax |
| --- | ---- | ---- | ---- |
| 1   | 100  | T1   | -    |

Фиксация транзакции T3: Изменения транзакции T3 становятся видимыми для новых транзакций.

| id  | data | xmin | xmax |
| --- | ---- | ---- | ---- |
| 1   | 100  | T1   | T3   |
